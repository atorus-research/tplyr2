<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Metadata and Traceability • tplyr2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Metadata and Traceability">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tplyr2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tplyr2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Layer Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/desc.html">Descriptive Statistics Layers</a></li>
    <li><a class="dropdown-item" href="../articles/count.html">Count Layers</a></li>
    <li><a class="dropdown-item" href="../articles/shift.html">Shift Layers</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Formatting</h6></li>
    <li><a class="dropdown-item" href="../articles/general_string_formatting.html">General String Formatting</a></li>
    <li><a class="dropdown-item" href="../articles/desc_layer_formatting.html">Advanced Descriptive Statistics Formatting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Table Customization</h6></li>
    <li><a class="dropdown-item" href="../articles/sort.html">Sorting a tplyr2 Table</a></li>
    <li><a class="dropdown-item" href="../articles/denom.html">Denominators</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">tplyr2 Options</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Metadata</h6></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Metadata and Traceability</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/riskdiff.html">Risk Difference</a></li>
    <li><a class="dropdown-item" href="../articles/analyze.html">Custom Analysis Layers</a></li>
    <li><a class="dropdown-item" href="../articles/serialization.html">Spec Serialization</a></li>
    <li><a class="dropdown-item" href="../articles/ard.html">Analysis Results Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Post-Processing</h6></li>
    <li><a class="dropdown-item" href="../articles/post_processing.html">Post-Processing</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Migration</h6></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migrating from Tplyr v1</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Metadata and Traceability</h1>
            
      

      <div class="d-none name"><code>metadata.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="why-traceability-matters">Why Traceability Matters<a class="anchor" aria-label="anchor" href="#why-traceability-matters"></a>
</h2>
<p>Clinical summary tables go through rigorous quality control. When a
reviewer questions a number, the programmer needs to trace that cell
back to the exact rows in the source data that produced it. Without a
systematic approach, this means re-reading code, reconstructing filter
logic, and manually subsetting the data – a tedious and error-prone
process.</p>
<p>tplyr2 solves this with cell-level metadata. When you build a table
with <code>metadata = TRUE</code>, the package records the filter
expressions that define every cell. You can then query any cell to
inspect the filters or retrieve the source data rows directly. This is
valuable for regulatory review, quality control, and powering
interactive drill-down interfaces in Shiny applications.</p>
</div>
<div class="section level2">
<h2 id="building-with-metadata">Building with Metadata<a class="anchor" aria-label="anchor" href="#building-with-metadata"></a>
</h2>
<p>Enabling metadata is a single argument to
<code><a href="../reference/tplyr_build.html">tplyr_build()</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"SEX"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/group_desc.html">group_desc</a></span><span class="op">(</span><span class="st">"AGE"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        format_strings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"n"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xxx"</span>, <span class="st">"n"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Mean (SD)"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x (xx.xx)"</span>, <span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The returned data frame has two additions compared to a normal
build:</p>
<ol style="list-style-type: decimal">
<li>A <code>row_id</code> column containing a unique identifier for each
output row.</li>
<li>A <code>tplyr_meta</code> attribute – a named list of metadata
objects keyed by <code>"row_id||column"</code>.</li>
</ol>
</div>
<div class="section level2">
<h2 id="row-ids">Row IDs<a class="anchor" aria-label="anchor" href="#row-ids"></a>
</h2>
<p>Row IDs are constructed from the layer index and row label values.
For a count layer with <code>target_var = "SEX"</code> in layer 1, the
IDs are <code>1_F</code> and <code>1_M</code>. For a descriptive
statistics layer in layer 2, they are <code>2_n</code> and
<code>2_Mean (SD)</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">row_id</span></span>
<span><span class="co">#&gt; [1] "1_F"         "1_M"         "2_n"         "2_Mean (SD)"</span></span></code></pre></div>
<p>IDs are deterministic – building the same spec against the same data
always produces the same values. The <code><a href="../reference/generate_row_ids.html">generate_row_ids()</a></code>
function creates these identifiers and can also be called on any tplyr2
output, even one built without metadata.</p>
</div>
<div class="section level2">
<h2 id="inspecting-cell-metadata">Inspecting Cell Metadata<a class="anchor" aria-label="anchor" href="#inspecting-cell-metadata"></a>
</h2>
<p>Once you have a row ID and a column name,
<code><a href="../reference/tplyr_meta_result.html">tplyr_meta_result()</a></code> returns the metadata object for that
cell:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"1_F"</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT01P, SEX</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT01P == "Placebo"</span></span>
<span><span class="co">#&gt;     SEX == "F"</span></span></code></pre></div>
<p>The <code>tplyr_meta</code> object contains:</p>
<ul>
<li>
<strong>names</strong>: Variable names relevant to this cell.</li>
<li>
<strong>filters</strong>: A list of R call expressions that,
combined with <code>&amp;</code>, define the data subset.</li>
<li>
<strong>layer_index</strong>: Which layer this cell belongs to.</li>
<li>
<strong>anti_join</strong>: <code>NULL</code> for normal cells, or a
<code>tplyr_meta_anti_join</code> object for missing subjects rows.</li>
</ul>
<p>If the cell does not exist, the function returns <code>NULL</code>.
If you try to access metadata on a result built without it, you get a
clear error:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_no_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result_no_meta</span>, <span class="st">"1_F"</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> No metadata available. Rebuild with metadata = TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-source-data">Getting Source Data<a class="anchor" aria-label="anchor" href="#getting-source-data"></a>
</h2>
<p>The real power of metadata is in <code><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset()</a></code>. It
evaluates the stored filters against the original data, returning the
rows that produced a cell:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">source_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"1_F"</span>, <span class="st">"res1"</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 53</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">$</span><span class="va">SEX</span> <span class="op">==</span> <span class="st">"F"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">$</span><span class="va">TRT01P</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Placebo"</span></span></code></pre></div>
<p>The number of rows returned matches the count displayed in the
cell.</p>
</div>
<div class="section level2">
<h2 id="metadata-for-count-layers">Metadata for Count Layers<a class="anchor" aria-label="anchor" href="#metadata-for-count-layers"></a>
</h2>
<p>Count cells are defined by the intersection of the column variable
level and the target variable level. When a <code>by</code> variable is
present, it adds an additional filter:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"DCDECOD"</span>, by <span class="op">=</span> <span class="st">"EOSSTT"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rowlabel1"</span>, <span class="st">"rowlabel2"</span>, <span class="st">"res1"</span>, <span class="st">"res2"</span>, <span class="st">"res3"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">rowlabel1</th>
<th align="left">rowlabel2</th>
<th align="left">res1</th>
<th align="left">res2</th>
<th align="left">res3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">COMPLETED</td>
<td align="left">ADVERSE EVENT</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
<tr class="even">
<td align="left">COMPLETED</td>
<td align="left">COMPLETED</td>
<td align="left">58 (67.4%)</td>
<td align="left">27 (32.1%)</td>
<td align="left">25 (29.8%)</td>
</tr>
<tr class="odd">
<td align="left">COMPLETED</td>
<td align="left">DEATH</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
<tr class="even">
<td align="left">COMPLETED</td>
<td align="left">LACK OF EFFICACY</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
<tr class="odd">
<td align="left">COMPLETED</td>
<td align="left">LOST TO FOLLOW-UP</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
<tr class="even">
<td align="left">COMPLETED</td>
<td align="left">PHYSICIAN DECISION</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rid</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">row_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">rid</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT01P, EOSSTT, DCDECOD</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT01P == "Placebo"</span></span>
<span><span class="co">#&gt;     EOSSTT == "COMPLETED"</span></span>
<span><span class="co">#&gt;     DCDECOD == "ADVERSE EVENT"</span></span></code></pre></div>
<div class="section level3">
<h3 id="total-rows">Total Rows<a class="anchor" aria-label="anchor" href="#total-rows"></a>
</h3>
<p>When <code>total_row = TRUE</code>, the total row’s metadata omits
the target variable filter, leaving only the column variable and any
by-variables:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"SEX"</span>, settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span>total_row <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">total_row</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="va">result</span><span class="op">$</span><span class="va">rowlabel1</span> <span class="op">==</span> <span class="st">"Total"</span>, <span class="op">]</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">total_row</span><span class="op">$</span><span class="va">row_id</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT01P, SEX</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT01P == "Placebo"</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">source_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">total_row</span><span class="op">$</span><span class="va">row_id</span>, <span class="st">"res1"</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 86</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="metadata-for-descriptive-statistics-layers">Metadata for Descriptive Statistics Layers<a class="anchor" aria-label="anchor" href="#metadata-for-descriptive-statistics-layers"></a>
</h2>
<p>Each row in a desc layer represents a statistic (n, mean, etc.), not
a data category. All stat rows within the same column point to the same
source data – the observations on which those statistics were
computed:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_desc.html">group_desc</a></span><span class="op">(</span><span class="st">"AGE"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        format_strings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"n"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xxx"</span>, <span class="st">"n"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Mean (SD)"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x (xx.xx)"</span>, <span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">n_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"1_n"</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">n_meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT01P, AGE</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT01P == "Placebo"</span></span></code></pre></div>
<p>The <code>names</code> field includes the target variable
(<code>AGE</code>). You can verify the statistics by subsetting and
computing them directly:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">source_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"1_n"</span>, <span class="st">"res1"</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">$</span><span class="va">AGE</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">source_rows</span><span class="op">$</span><span class="va">AGE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         n      mean        sd </span></span>
<span><span class="co">#&gt; 86.000000 75.209302  8.590167</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="where-filters-in-metadata">Where Filters in Metadata<a class="anchor" aria-label="anchor" href="#where-filters-in-metadata"></a>
</h2>
<p>Both spec-level and layer-level <code>where</code> filters are
captured in the metadata, so you can always see the full filtering
chain:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  where <span class="op">=</span> <span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"SEX"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">tplyr_adsl</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">result</span><span class="op">$</span><span class="va">row_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT01P, SEX, SAFFL</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT01P == "Placebo"</span></span>
<span><span class="co">#&gt;     SEX == "F"</span></span>
<span><span class="co">#&gt;     SAFFL == "Y"</span></span></code></pre></div>
<p>The filter list includes <code>SAFFL == "Y"</code> alongside the
column and target variable filters. The <code>names</code> field lists
every variable in the subsetting logic.</p>
</div>
<div class="section level2">
<h2 id="anti-join-metadata-for-missing-subjects">Anti-Join Metadata for Missing Subjects<a class="anchor" aria-label="anchor" href="#anti-join-metadata-for-missing-subjects"></a>
</h2>
<p>Some tables include a row for subjects in the population data but not
in the analysis data. The metadata for these rows uses a special
<code>anti_join</code> field:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  TRT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>  USUBJID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S3"</span><span class="op">)</span>,</span>
<span>  VAL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span>, <span class="st">"X"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  TRT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"A"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>  USUBJID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S4"</span>, <span class="st">"S3"</span>, <span class="st">"S5"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT"</span>,</span>
<span>  pop_data <span class="op">=</span> <span class="fu"><a href="../reference/pop_data.html">pop_data</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"TRT"</span><span class="op">)</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"VAL"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        distinct_by <span class="op">=</span> <span class="st">"USUBJID"</span>,</span>
<span>        missing_subjects <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        missing_subjects_label <span class="op">=</span> <span class="st">"Not in Target"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">target</span>, pop_data <span class="op">=</span> <span class="va">pop</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">result</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rowlabel1"</span>, <span class="st">"res1"</span>, <span class="st">"res2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">rowlabel1</th>
<th align="left">res1</th>
<th align="left">res2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Not in Target</td>
<td align="left">1 (33.3%)</td>
<td align="left">1 (50.0%)</td>
</tr>
<tr class="even">
<td align="left">X</td>
<td align="left">1 (33.3%)</td>
<td align="left">1 (50.0%)</td>
</tr>
<tr class="odd">
<td align="left">Y</td>
<td align="left">1 (33.3%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ms_row</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="va">result</span><span class="op">$</span><span class="va">rowlabel1</span> <span class="op">==</span> <span class="st">"Not in Target"</span>, <span class="op">]</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_result.html">tplyr_meta_result</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">ms_row</span><span class="op">$</span><span class="va">row_id</span>, <span class="st">"res1"</span><span class="op">)</span></span>
<span><span class="va">meta</span></span>
<span><span class="co">#&gt; tplyr_meta [layer 1]</span></span>
<span><span class="co">#&gt;   Names: TRT, VAL</span></span>
<span><span class="co">#&gt;   Filters:</span></span>
<span><span class="co">#&gt;     TRT == "A"</span></span>
<span><span class="co">#&gt;   Anti-join:</span></span>
<span><span class="co">#&gt;     On: USUBJID</span></span>
<span><span class="co">#&gt;     Pop filters:</span></span>
<span><span class="co">#&gt;       TRT == "A"</span></span></code></pre></div>
<p>The <code>anti_join</code> contains a <code>join_meta</code> (filters
for the population side) and <code>on</code> (the join key, typically
<code>"USUBJID"</code>). When calling <code><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset()</a></code>
on such a row, you must supply <code>pop_data</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">missing_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">ms_row</span><span class="op">$</span><span class="va">row_id</span>, <span class="st">"res1"</span>,</span>
<span>                                <span class="va">target</span>, pop_data <span class="op">=</span> <span class="va">pop</span><span class="op">)</span></span>
<span><span class="va">missing_a</span></span>
<span><span class="co">#&gt;   TRT USUBJID</span></span>
<span><span class="co">#&gt; 1   A      S4</span></span></code></pre></div>
<p>Subject S4 is in the population for <code>TRT = "A"</code> but absent
from the target, so the anti-join returns that one row. Omitting
<code>pop_data</code> produces a warning:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">ms_row</span><span class="op">$</span><span class="va">row_id</span>, <span class="st">"res1"</span>, <span class="va">target</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: pop_data is required for anti-join metadata but was not provided</span></span>
<span><span class="co">#&gt;   TRT USUBJID VAL</span></span>
<span><span class="co">#&gt; 1   A      S1   X</span></span>
<span><span class="co">#&gt; 2   A      S2   Y</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="practical-applications">Practical Applications<a class="anchor" aria-label="anchor" href="#practical-applications"></a>
</h2>
<p>The most common use of metadata is cell verification during QC:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">data</span>, metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">source</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, row_id <span class="op">=</span> <span class="st">"1_F"</span>, column <span class="op">=</span> <span class="st">"res2"</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span></span></code></pre></div>
<p>The metadata system also lends itself to Shiny applications where
clicking a cell triggers <code><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset()</a></code>, displaying
the source records in a detail panel:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">table_cell_click</span>, <span class="op">{</span></span>
<span>  <span class="va">click</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">table_cell_click</span></span>
<span>  <span class="va">row_id</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">row_id</span><span class="op">[</span><span class="va">click</span><span class="op">$</span><span class="va">row</span><span class="op">]</span></span>
<span>  <span class="va">col_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">[</span><span class="va">click</span><span class="op">$</span><span class="va">col</span><span class="op">]</span></span>
<span>  <span class="va">source_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_meta_subset.html">tplyr_meta_subset</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">row_id</span>, <span class="va">col_name</span>, <span class="va">original_data</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">detail_table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="va">source_data</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Purpose</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>tplyr_build(..., metadata = TRUE)</code></td>
<td>Build with metadata enabled</td>
</tr>
<tr class="even">
<td><code>generate_row_ids(result)</code></td>
<td>Create row identifiers</td>
</tr>
<tr class="odd">
<td><code>tplyr_meta_result(result, row_id, column)</code></td>
<td>Inspect filter expressions for a cell</td>
</tr>
<tr class="even">
<td><code>tplyr_meta_subset(result, row_id, column, data)</code></td>
<td>Retrieve source data rows</td>
</tr>
</tbody>
</table>
<p>Every cell carries its own filter expressions – column variable,
target variable, by-variable, where clauses, and anti-join logic for
missing subjects. These expressions are stored at build time but only
evaluated when you request a subset, keeping the metadata lightweight
while providing exact reproducibility of every number in your table.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Stackhouse.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
