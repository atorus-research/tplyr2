<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spec Serialization • tplyr2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Spec Serialization">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tplyr2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tplyr2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Layer Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/desc.html">Descriptive Statistics Layers</a></li>
    <li><a class="dropdown-item" href="../articles/count.html">Count Layers</a></li>
    <li><a class="dropdown-item" href="../articles/shift.html">Shift Layers</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Formatting</h6></li>
    <li><a class="dropdown-item" href="../articles/general_string_formatting.html">General String Formatting</a></li>
    <li><a class="dropdown-item" href="../articles/desc_layer_formatting.html">Advanced Descriptive Statistics Formatting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Table Customization</h6></li>
    <li><a class="dropdown-item" href="../articles/sort.html">Sorting a tplyr2 Table</a></li>
    <li><a class="dropdown-item" href="../articles/denom.html">Denominators</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">tplyr2 Options</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Metadata</h6></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Metadata and Traceability</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/riskdiff.html">Risk Difference</a></li>
    <li><a class="dropdown-item" href="../articles/analyze.html">Custom Analysis Layers</a></li>
    <li><a class="dropdown-item" href="../articles/serialization.html">Spec Serialization</a></li>
    <li><a class="dropdown-item" href="../articles/ard.html">Analysis Results Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Post-Processing</h6></li>
    <li><a class="dropdown-item" href="../articles/post_processing.html">Post-Processing</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Migration</h6></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migrating from Tplyr v1</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spec Serialization</h1>
            
      

      <div class="d-none name"><code>serialization.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the central design principles of tplyr2 is the separation of
specification from data. A <code><a href="../reference/tplyr_spec.html">tplyr_spec()</a></code> object describes
<em>what</em> a table should contain – the column structure, the layers,
the formatting rules – without touching any actual dataset. Data is only
supplied at build time via <code>tplyr_build(spec, data)</code>.</p>
<p>This separation creates a natural opportunity: if the spec is pure
configuration, it can be saved to a file and loaded back later. tplyr2
supports serializing specs to both JSON and YAML formats. This opens up
several practical workflows:</p>
<ul>
<li>
<strong>Version control</strong>: Specs stored as JSON or YAML are
plain text, so they integrate naturally with Git. You can track changes
to your table definitions alongside your analysis code.</li>
<li>
<strong>Portability</strong>: A spec file can be shared between team
members or across studies. The recipient loads it and builds against
their own data.</li>
<li>
<strong>Reproducibility</strong>: Archiving a spec alongside its
output creates a clear record of exactly what configuration produced a
given table.</li>
<li>
<strong>Regulatory submissions</strong>: A machine-readable table
definition can serve as supporting documentation in a submission
package.</li>
</ul>
</div>
<div class="section level2">
<h2 id="writing-a-spec-to-json">Writing a Spec to JSON<a class="anchor" aria-label="anchor" href="#writing-a-spec-to-json"></a>
</h2>
<p>The <code><a href="../reference/tplyr_write_spec.html">tplyr_write_spec()</a></code> function takes a spec object and
a file path. The format is determined by the file extension: use
<code>.json</code> for JSON output.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  where <span class="op">=</span> <span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span><span class="st">"SEX"</span>, by <span class="op">=</span> <span class="st">"Sex n (%)"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/group_desc.html">group_desc</a></span><span class="op">(</span></span>
<span>      <span class="st">"AGE"</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"Age (Years)"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        format_strings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"n"</span>         <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xxx"</span>, <span class="st">"n"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Mean (SD)"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x (xx.xx)"</span>, <span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Median"</span>    <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x"</span>, <span class="st">"median"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Min, Max"</span>  <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx, xx"</span>, <span class="st">"min"</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">json_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tplyr_write_spec.html">tplyr_write_spec</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">json_path</span><span class="op">)</span></span></code></pre></div>
<p>The file is now a plain-text JSON document. Let’s verify that we can
read it back and build the same table.</p>
</div>
<div class="section level2">
<h2 id="reading-a-spec-back">Reading a Spec Back<a class="anchor" aria-label="anchor" href="#reading-a-spec-back"></a>
</h2>
<p>The <code><a href="../reference/tplyr_read_spec.html">tplyr_read_spec()</a></code> function reads a spec from a JSON
or YAML file and reconstructs the full <code>tplyr_spec</code> object,
including all expressions, format strings, and layer configurations.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loaded_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_read_spec.html">tplyr_read_spec</a></span><span class="op">(</span><span class="va">json_path</span><span class="op">)</span></span>
<span><span class="va">loaded_spec</span></span>
<span><span class="co">#&gt; tplyr2 table specification</span></span>
<span><span class="co">#&gt; Column variables: TRT01PWhere: SAFFL == "Y"Layers: 2[1] count: SEX (Layer 1)[2] desc: AGE (Layer 2)</span></span></code></pre></div>
<p>The loaded spec is functionally identical to the original. You can
build it against any dataset that has the required columns.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">loaded_spec</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">result</span><span class="op">[</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^ord"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">rowlabel1</th>
<th align="left">rowlabel2</th>
<th align="left">res1</th>
<th align="left">res2</th>
<th align="left">res3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Sex n (%)</td>
<td align="left">F</td>
<td align="left">53 (61.6%)</td>
<td align="left">40 (47.6%)</td>
<td align="left">50 (59.5%)</td>
</tr>
<tr class="even">
<td align="left">Sex n (%)</td>
<td align="left">M</td>
<td align="left">33 (38.4%)</td>
<td align="left">44 (52.4%)</td>
<td align="left">34 (40.5%)</td>
</tr>
<tr class="odd">
<td align="left">Age (Years)</td>
<td align="left">n</td>
<td align="left">86</td>
<td align="left">84</td>
<td align="left">84</td>
</tr>
<tr class="even">
<td align="left">Age (Years)</td>
<td align="left">Mean (SD)</td>
<td align="left">75.2 ( 8.59)</td>
<td align="left">74.4 ( 7.89)</td>
<td align="left">75.7 ( 8.29)</td>
</tr>
<tr class="odd">
<td align="left">Age (Years)</td>
<td align="left">Median</td>
<td align="left">76.0</td>
<td align="left">76.0</td>
<td align="left">77.5</td>
</tr>
<tr class="even">
<td align="left">Age (Years)</td>
<td align="left">Min, Max</td>
<td align="left">52, 89</td>
<td align="left">56, 88</td>
<td align="left">51, 88</td>
</tr>
</tbody>
</table>
<p>This is the same output you would get from building the original spec
directly. The round-trip – write to disk, read back, build – preserves
everything.</p>
</div>
<div class="section level2">
<h2 id="yaml-format">YAML Format<a class="anchor" aria-label="anchor" href="#yaml-format"></a>
</h2>
<p>If you prefer YAML over JSON, simply use a <code>.yaml</code> or
<code>.yml</code> file extension. The API is identical.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yaml_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".yaml"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tplyr_write_spec.html">tplyr_write_spec</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">yaml_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">yaml_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_read_spec.html">tplyr_read_spec</a></span><span class="op">(</span><span class="va">yaml_path</span><span class="op">)</span></span>
<span><span class="va">yaml_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">yaml_spec</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Confirm the results match</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span></span>
<span>  <span class="va">result</span><span class="op">[</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^ord"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">yaml_result</span><span class="op">[</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^ord"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">yaml_result</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>YAML tends to be more readable for human review, while JSON is more
widely supported by automated tools. The choice between them is a matter
of preference; tplyr2 handles both transparently.</p>
</div>
<div class="section level2">
<h2 id="what-gets-serialized">What Gets Serialized<a class="anchor" aria-label="anchor" href="#what-gets-serialized"></a>
</h2>
<p>A tplyr_spec can contain several types of R objects that do not have
direct equivalents in JSON or YAML. The serialization system handles
each one with a specific convention.</p>
<div class="section level3">
<h3 id="expressions">Expressions<a class="anchor" aria-label="anchor" href="#expressions"></a>
</h3>
<p>Filter expressions like <code>where = SAFFL == "Y"</code> are R
language objects. They are serialized by deparsing the expression to a
string and wrapping it in a marker object.</p>
<p>In JSON, a <code>where</code> clause looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="dt">"where"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="dt">"_expr"</span><span class="fu">:</span> <span class="st">"SAFFL == </span><span class="ch">\"</span><span class="st">Y</span><span class="ch">\"</span><span class="st">"</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>On deserialization, the string is parsed back into an R expression
using <code><a href="https://rlang.r-lib.org/reference/parse_expr.html" class="external-link">rlang::parse_expr()</a></code>. This preserves the original
filter logic exactly.</p>
</div>
<div class="section level3">
<h3 id="format-strings">Format Strings<a class="anchor" aria-label="anchor" href="#format-strings"></a>
</h3>
<p><code><a href="../reference/f_str.html">f_str()</a></code> objects are stored as their component parts: the
format template, the variable names, and the optional <code>empty</code>
parameter. A marker class field (<code>_class: "tplyr_f_str"</code>)
identifies them for reconstruction.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="dt">"format_string"</span><span class="fu">:</span> <span class="st">"xx.x (xx.xx)"</span><span class="fu">,</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="dt">"vars"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"mean"</span><span class="ot">,</span> <span class="st">"sd"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="dt">"_class"</span><span class="fu">:</span> <span class="st">"tplyr_f_str"</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>When read back, the <code><a href="../reference/f_str.html">f_str()</a></code> constructor is called with
these components, re-parsing the format string and rebuilding the
internal structure.</p>
</div>
<div class="section level3">
<h3 id="labels-in-by">Labels in <code>by</code><a class="anchor" aria-label="anchor" href="#labels-in-by"></a>
</h3>
<p>When you use <code><a href="../reference/label.html">label()</a></code> in a <code>by</code> parameter to
create an explicit text label, the label is serialized with a type
marker so it can be distinguished from a data variable name.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"Age (Years)"</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="dt">"_type"</span><span class="fu">:</span> <span class="st">"label"</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Regular data variable names (character strings) pass through
as-is.</p>
</div>
<div class="section level3">
<h3 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h3>
<p>Analyze layers created with <code><a href="../reference/group_analyze.html">group_analyze()</a></code> include a
user-defined function. These are serialized by deparsing the function
body to a string.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="dt">"_fn"</span><span class="fu">:</span> <span class="st">"function(.data, .target_var) {</span><span class="ch">\n</span><span class="st">  ...</span><span class="ch">\n</span><span class="st">}"</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>On deserialization, the string is parsed and evaluated to recreate
the function object. Note that functions which depend on objects in a
specific environment (closures that capture external variables) may not
survive the round-trip. For best results, write analyze functions that
are self-contained.</p>
</div>
</div>
<div class="section level2">
<h2 id="examining-the-serialized-output">Examining the Serialized Output<a class="anchor" aria-label="anchor" href="#examining-the-serialized-output"></a>
</h2>
<p>Let’s look at the actual JSON content produced by our earlier spec to
see these conventions in practice.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">json_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">json_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">json_content</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "cols": "TRT01P",</span></span>
<span><span class="co">#&gt;   "where": {</span></span>
<span><span class="co">#&gt;     "_expr": "SAFFL == \"Y\""</span></span>
<span><span class="co">#&gt;   },</span></span>
<span><span class="co">#&gt;   "layers": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "target_var": "SEX",</span></span>
<span><span class="co">#&gt;       "by": "Sex n (%)",</span></span>
<span><span class="co">#&gt;       "where": null,</span></span>
<span><span class="co">#&gt;       "layer_type": "count",</span></span>
<span><span class="co">#&gt;       "settings": {</span></span>
<span><span class="co">#&gt;         "indentation": "  ",</span></span>
<span><span class="co">#&gt;         "total_row": false,</span></span>
<span><span class="co">#&gt;         "total_row_label": "Total",</span></span>
<span><span class="co">#&gt;         "total_row_count_missings": true,</span></span>
<span><span class="co">#&gt;         "missing_subjects": false,</span></span>
<span><span class="co">#&gt;         "missing_subjects_label": "Missing",</span></span>
<span><span class="co">#&gt;         "stats_as_columns": false</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     },</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "target_var": "AGE",</span></span>
<span><span class="co">#&gt;       "by": "Age (Years)",</span></span>
<span><span class="co">#&gt;       "where": null,</span></span>
<span><span class="co">#&gt;       "layer_type": "desc",</span></span>
<span><span class="co">#&gt;       "settings": {</span></span>
<span><span class="co">#&gt;         "format_strings": {</span></span>
<span><span class="co">#&gt;           "n": {</span></span>
<span><span class="co">#&gt;             "format_string": "xxx",</span></span>
<span><span class="co">#&gt;             "vars": "n",</span></span>
<span><span class="co">#&gt;             "_class": "tplyr_f_str"</span></span>
<span><span class="co">#&gt;           },</span></span>
<span><span class="co">#&gt;           "Mean (SD)": {</span></span>
<span><span class="co">#&gt;             "format_string": "xx.x (xx.xx)",</span></span>
<span><span class="co">#&gt;             "vars": ["mean", "sd"],</span></span>
<span><span class="co">#&gt;             "_class": "tplyr_f_str"</span></span>
<span><span class="co">#&gt;           },</span></span>
<span><span class="co">#&gt;           "Median": {</span></span>
<span><span class="co">#&gt;             "format_string": "xx.x",</span></span>
<span><span class="co">#&gt;             "vars": "median",</span></span>
<span><span class="co">#&gt;             "_class": "tplyr_f_str"</span></span>
<span><span class="co">#&gt;           },</span></span>
<span><span class="co">#&gt;           "Min, Max": {</span></span>
<span><span class="co">#&gt;             "format_string": "xx, xx",</span></span>
<span><span class="co">#&gt;             "vars": ["min", "max"],</span></span>
<span><span class="co">#&gt;             "_class": "tplyr_f_str"</span></span>
<span><span class="co">#&gt;           }</span></span>
<span><span class="co">#&gt;         },</span></span>
<span><span class="co">#&gt;         "indentation": "  ",</span></span>
<span><span class="co">#&gt;         "total_row": false,</span></span>
<span><span class="co">#&gt;         "total_row_label": "Total",</span></span>
<span><span class="co">#&gt;         "total_row_count_missings": true,</span></span>
<span><span class="co">#&gt;         "missing_subjects": false,</span></span>
<span><span class="co">#&gt;         "missing_subjects_label": "Missing",</span></span>
<span><span class="co">#&gt;         "stats_as_columns": false</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ]</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>You can see the structure: the top-level <code>cols</code> and
<code>where</code> fields, followed by the <code>layers</code> array.
Each layer carries its <code>target_var</code>, <code>by</code>,
<code>where</code>, <code>layer_type</code>, and <code>settings</code>.
Within the settings, <code>format_strings</code> contains the serialized
<code>f_str</code> objects.</p>
</div>
<div class="section level2">
<h2 id="a-more-complex-example">A More Complex Example<a class="anchor" aria-label="anchor" href="#a-more-complex-example"></a>
</h2>
<p>Let’s serialize a spec that exercises more of the system: nested
counts with distinct counting, a <code>where</code> clause, and a total
row.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">complex_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_spec.html">tplyr_spec</a></span><span class="op">(</span></span>
<span>  cols <span class="op">=</span> <span class="st">"TRT01P"</span>,</span>
<span>  where <span class="op">=</span> <span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span>,</span>
<span>  total_groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/total_group.html">total_group</a></span><span class="op">(</span><span class="st">"TRT01P"</span>, label <span class="op">=</span> <span class="st">"Total"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  layers <span class="op">=</span> <span class="fu"><a href="../reference/tplyr_layers.html">tplyr_layers</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/group_count.html">group_count</a></span><span class="op">(</span></span>
<span>      <span class="st">"RACE"</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"Race n (%)"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        total_row <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        total_row_label <span class="op">=</span> <span class="st">"Total"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/group_desc.html">group_desc</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGE"</span>, <span class="st">"WEIGHTBL"</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"Baseline Measurements"</span>,</span>
<span>      settings <span class="op">=</span> <span class="fu"><a href="../reference/layer_settings.html">layer_settings</a></span><span class="op">(</span></span>
<span>        format_strings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"n"</span>         <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xxx"</span>, <span class="st">"n"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Mean (SD)"</span> <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x (xx.xx)"</span>, <span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>          <span class="st">"Min, Max"</span>  <span class="op">=</span> <span class="fu"><a href="../reference/f_str.html">f_str</a></span><span class="op">(</span><span class="st">"xx.x, xx.x"</span>, <span class="st">"min"</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">complex_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tplyr_write_spec.html">tplyr_write_spec</a></span><span class="op">(</span><span class="va">complex_spec</span>, <span class="va">complex_path</span><span class="op">)</span></span></code></pre></div>
<p>Now read it back and build.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reloaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_read_spec.html">tplyr_read_spec</a></span><span class="op">(</span><span class="va">complex_path</span><span class="op">)</span></span>
<span><span class="va">complex_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">reloaded</span>, <span class="va">tplyr_adsl</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">complex_result</span><span class="op">[</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^ord"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">complex_result</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="18%">
<col width="28%">
<col width="8%">
<col width="11%">
<col width="11%">
<col width="11%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left">rowlabel1</th>
<th align="left">rowlabel2</th>
<th align="left">rowlabel3</th>
<th align="left">res1</th>
<th align="left">res2</th>
<th align="left">res3</th>
<th align="left">res4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Race n (%)</td>
<td align="left">AMERICAN INDIAN OR ALASKA NATIVE</td>
<td align="left"></td>
<td align="left">0 ( 0.0%)</td>
<td align="left">1 ( 0.4%)</td>
<td align="left">1 ( 1.2%)</td>
<td align="left">0 ( 0.0%)</td>
</tr>
<tr class="even">
<td align="left">Race n (%)</td>
<td align="left">BLACK OR AFRICAN AMERICAN</td>
<td align="left"></td>
<td align="left">8 ( 9.3%)</td>
<td align="left">23 ( 9.1%)</td>
<td align="left">9 (10.7%)</td>
<td align="left">6 ( 7.1%)</td>
</tr>
<tr class="odd">
<td align="left">Race n (%)</td>
<td align="left">Total</td>
<td align="left"></td>
<td align="left">86 (100.0%)</td>
<td align="left">254 (100.0%)</td>
<td align="left">84 (100.0%)</td>
<td align="left">84 (100.0%)</td>
</tr>
<tr class="even">
<td align="left">Race n (%)</td>
<td align="left">WHITE</td>
<td align="left"></td>
<td align="left">78 (90.7%)</td>
<td align="left">230 (90.6%)</td>
<td align="left">74 (88.1%)</td>
<td align="left">78 (92.9%)</td>
</tr>
<tr class="odd">
<td align="left">Baseline Measurements</td>
<td align="left">AGE</td>
<td align="left">n</td>
<td align="left">86</td>
<td align="left">254</td>
<td align="left">84</td>
<td align="left">84</td>
</tr>
<tr class="even">
<td align="left">Baseline Measurements</td>
<td align="left">AGE</td>
<td align="left">Mean (SD)</td>
<td align="left">75.2 ( 8.59)</td>
<td align="left">75.1 ( 8.25)</td>
<td align="left">74.4 ( 7.89)</td>
<td align="left">75.7 ( 8.29)</td>
</tr>
<tr class="odd">
<td align="left">Baseline Measurements</td>
<td align="left">AGE</td>
<td align="left">Min, Max</td>
<td align="left">52.0, 89.0</td>
<td align="left">51.0, 89.0</td>
<td align="left">56.0, 88.0</td>
<td align="left">51.0, 88.0</td>
</tr>
<tr class="even">
<td align="left">Baseline Measurements</td>
<td align="left">WEIGHTBL</td>
<td align="left">n</td>
<td align="left">86</td>
<td align="left">253</td>
<td align="left">84</td>
<td align="left">83</td>
</tr>
<tr class="odd">
<td align="left">Baseline Measurements</td>
<td align="left">WEIGHTBL</td>
<td align="left">Mean (SD)</td>
<td align="left">62.8 (12.77)</td>
<td align="left">66.6 (14.13)</td>
<td align="left">70.0 (14.65)</td>
<td align="left">67.3 (14.12)</td>
</tr>
<tr class="even">
<td align="left">Baseline Measurements</td>
<td align="left">WEIGHTBL</td>
<td align="left">Min, Max</td>
<td align="left">34.0, 86.2</td>
<td align="left">34.0, 108.0</td>
<td align="left">41.7, 108.0</td>
<td align="left">45.4, 106.1</td>
</tr>
</tbody>
</table>
<p>The total group, total row, multi-target descriptive layer, and all
formatting survive the round-trip.</p>
</div>
<div class="section level2">
<h2 id="use-cases">Use Cases<a class="anchor" aria-label="anchor" href="#use-cases"></a>
</h2>
<div class="section level3">
<h3 id="version-controlled-table-definitions">Version-Controlled Table Definitions<a class="anchor" aria-label="anchor" href="#version-controlled-table-definitions"></a>
</h3>
<p>Storing specs as JSON or YAML files in your project repository means
that every change to a table definition is tracked. If a reviewer asks
“what changed between the draft and final version of Table 14.1?”, you
can answer that question with a <code>git diff</code> of the spec
file.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In your analysis script</span></span>
<span><span class="va">spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_read_spec.html">tplyr_read_spec</a></span><span class="op">(</span><span class="st">"specs/table_14_1.json"</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">spec</span>, <span class="va">adsl</span><span class="op">)</span></span></code></pre></div>
<p>The spec file is a plain-text artifact that reviewers can inspect
without running R.</p>
</div>
<div class="section level3">
<h3 id="sharing-across-teams">Sharing Across Teams<a class="anchor" aria-label="anchor" href="#sharing-across-teams"></a>
</h3>
<p>A statistician can define the table structure and save the spec. A
programmer on a different system can load it and build against the study
data. The spec travels as a lightweight file rather than an R object
that requires a specific environment.</p>
</div>
<div class="section level3">
<h3 id="applying-a-spec-to-different-data">Applying a Spec to Different Data<a class="anchor" aria-label="anchor" href="#applying-a-spec-to-different-data"></a>
</h3>
<p>Because specs carry no data, the same spec can be applied to datasets
from different studies, time points, or populations. This is useful for
standardized tables that appear across multiple studies.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same spec, different data subsets</span></span>
<span><span class="va">saffl_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">loaded_spec</span>, <span class="va">tplyr_adsl</span><span class="op">[</span><span class="va">tplyr_adsl</span><span class="op">$</span><span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ittfl_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tplyr_build.html">tplyr_build</a></span><span class="op">(</span><span class="va">loaded_spec</span>, <span class="va">tplyr_adsl</span><span class="op">[</span><span class="va">tplyr_adsl</span><span class="op">$</span><span class="va">ITTFL</span> <span class="op">==</span> <span class="st">"Y"</span>, <span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="regulatory-archival">Regulatory Archival<a class="anchor" aria-label="anchor" href="#regulatory-archival"></a>
</h3>
<p>For regulatory submissions, archiving a machine-readable table
definition alongside the analysis output provides an additional layer of
documentation. The JSON or YAML file describes exactly how the table was
configured, in a format that does not require R to interpret.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Stackhouse.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
